name: Release to Package Registries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.0)"
        required: true
        type: string

env:
  PACKAGE_NAME: cyberwave-cloud-node
  # Buildkite Package Registries configuration
  BUILDKITE_ORG_SLUG: cyberwave
  BUILDKITE_DEB_REGISTRY_SLUG: cyberwave-cloud-node
  BUILDKITE_APK_REGISTRY_SLUG: cyberwave-cloud-node-alpine

jobs:
  build-deb:
    name: Build Debian Package (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Use ubuntu-22.04 for GLIBC 2.35 compatibility
          # This works on Ubuntu 22.04+ and most modern Linux distros
          - arch: amd64
            runner: ubuntu-22.04
          - arch: arm64
            runner: ubuntu-22.04-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[build]"

      - name: Build binary with PyInstaller
        run: |
          chmod +x build.sh
          ./build.sh
          echo "‚úÖ Binary built successfully"
          ls -la dist/

      - name: Verify binary works
        run: |
          ./dist/cyberwave-cloud-node --version || ./dist/cyberwave-cloud-node --help
          echo "‚úÖ Binary verification passed"

      - name: Create Debian package structure
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PACKAGE_NAME}_${VERSION}_${ARCH}"

          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}"

          # Copy binary
          cp dist/cyberwave-cloud-node "${PKG_DIR}/usr/bin/"
          chmod 755 "${PKG_DIR}/usr/bin/cyberwave-cloud-node"

          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: ${PACKAGE_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: Cyberwave <info@cyberwave.com>
          Homepage: https://cyberwave.com
          Description: Cyberwave Cloud Node for inference and training
           Turn any computer into a Cyberwave Cloud Node for inference and training via MQTT.
           .
           Features:
            - Run inference workloads on demand
            - Execute training jobs remotely
            - Connect to Cyberwave platform via MQTT
          EOF

          # Remove leading spaces from control file (heredoc artifact)
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/control"

          # Create copyright file
          cat > "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/copyright" << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: cyberwave-cloud-node
          Upstream-Contact: info@cyberwave.com
          Source: https://github.com/cyberwave-os/cyberwave

          Files: *
          Copyright: $(date +%Y) Cyberwave
          License: MIT
          EOF

          # Create changelog
          cat > "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian" << EOF
          ${PACKAGE_NAME} (${VERSION}) stable; urgency=medium

            * Release ${VERSION}

           -- Cyberwave <info@cyberwave.com>  $(date -R)
          EOF
          gzip -9 "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian"

          echo "‚úÖ Debian package structure created"

      - name: Build .deb package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PACKAGE_NAME}_${VERSION}_${ARCH}"

          dpkg-deb --build "${PKG_DIR}"
          echo "‚úÖ Debian package built"
          ls -la *.deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 7

  publish-to-buildkite:
    name: Publish to Buildkite Package Registries
    runs-on: ubuntu-latest
    needs: [build-deb]
    steps:
      - name: Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true
          path: deb-packages

      # - name: Download all .apk artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #     pattern: apk-*
      #     merge-multiple: true
      #     path: apk-packages

      - name: List downloaded packages
        run: |
          echo "=== Debian packages ==="
          ls -la deb-packages/

      - name: Push Debian packages to Buildkite
        env:
          BUILDKITE_API_TOKEN: ${{ secrets.BUILDKITE_API_TOKEN }}
        run: |
          # Debug: Check if env vars are set (without exposing values)
          if [ -z "${BUILDKITE_API_TOKEN}" ]; then
            echo "‚ùå ERROR: BUILDKITE_API_TOKEN is not set!"
            echo "Please add BUILDKITE_API_TOKEN to your repository secrets."
            exit 1
          fi
          echo "‚úÖ BUILDKITE_API_TOKEN is set"
          echo "üìç Org: ${BUILDKITE_ORG_SLUG}, Registry: ${BUILDKITE_DEB_REGISTRY_SLUG}"

          API_URL="https://api.buildkite.com/v2/packages/organizations/${BUILDKITE_ORG_SLUG}/registries/${BUILDKITE_DEB_REGISTRY_SLUG}/packages"

          for DEB_FILE in deb-packages/*.deb; do
            echo "üì¶ Uploading ${DEB_FILE}..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}" \
              -H "Authorization: Bearer ${BUILDKITE_API_TOKEN}" \
              -F "file=@${DEB_FILE}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ Successfully uploaded ${DEB_FILE}"
            else
              echo "‚ùå Failed to upload ${DEB_FILE} (HTTP ${HTTP_CODE})"
              echo "Response: ${BODY}"
              exit 1
            fi
          done

          echo "‚úÖ All Debian packages uploaded"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-deb]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "{deb,apk}-*"
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            *.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [create-github-release]
    if: always()
    steps:
      - name: Post success to Slack
        if: needs.publish-to-buildkite.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: builds
            text: "‚úÖ cyberwave-cloud-node ${{ github.ref_name }} released to APT repositories"

      - name: Post failure to Slack
        if: needs.publish-to-buildkite.result == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: builds
            text: "‚ùå cyberwave-cloud-node package release failed <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Action Run>"
